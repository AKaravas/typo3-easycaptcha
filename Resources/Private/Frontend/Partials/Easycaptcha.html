<html data-namespace-typo3-fluid="true"
      xmlns:core="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
      xmlns:easyCaptcha="http://typo3.org/ns/ColumbusInteractive/EasyCaptcha/ViewHelpers"
      xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:formvh="http://typo3.org/ns/TYPO3/CMS/Form/ViewHelpers">
<formvh:renderRenderable renderable="{element}">
    <f:render arguments="{element: element}" contentAs="elementContent" partial="Field/Field">
        <f:format.raw>
            <easyCaptcha:render/>
            <div class="{element.properties.containerClassAttribute}">
                <img alt="{captchaImageAltAttribute}" src="{captchaImage}"/>
            </div>
            <div class="captcha-actions">
                <f:if condition="{element.properties.enableTts} == true">
                    <button id="tts-play" type="button" title="{f:translate(key: 'playButton', extensionName: 'easycaptcha')}">
                        <core:icon identifier="actions-play" size="small"/>
                    </button>
                </f:if>
                <button type="submit" title="{f:translate(key: 'refreshButton', extensionName: 'easycaptcha')}">
                    <core:icon identifier="actions-refresh" size="small"/>
                </button>
            </div>
            <div class="form-group">
                <label class="control-label">
                    <f:translate key="LLL:EXT:easycaptcha/Resources/Private/Language/locallang.xlf:captchaLabel"/>
                </label>
                <f:form.textfield
                    additionalAttributes="{formvh:translateElementProperty(element: element, property: 'fluidAdditionalAttributes')}"
                    class="form-control"
                    errorClass="{element.properties.elementErrorClassAttribute}"
                    id="{element.uniqueIdentifier}"
                    property="{element.identifier}"
                    value=""
                />
            </div>
        </f:format.raw>
        <style type="text/css">
            .captcha-actions {
                margin-top: 10px;
            }
        </style>
        <f:if condition="{element.properties.enableTts} == true">
            <script type="application/javascript">
                if (window.speechSynthesis !== undefined) {
                    (async function () {
                        let synth = window.speechSynthesis;
                        document.getElementById('tts-play').addEventListener('click', async function (e) {
                            let response = await fetch('<f:format.raw>{ttsHelperPath}</f:format.raw>');

                            if (response.ok) {
                                let json = await response.json();
                                let utterance = new SpeechSynthesisUtterance(json.word);
                                utterance.rate = 0.8;
                                utterance.pitch = 1;
                                synth.speak(utterance);
                            }
                        });
                    })();
                }
            </script>
        </f:if>
    </f:render>
</formvh:renderRenderable>
</html>
